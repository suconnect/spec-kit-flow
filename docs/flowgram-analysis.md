# Flowgram.ai Demo-Free-Layout ????

**????**: 2025-10-31  
**????**: demo-free-layout v0.1.0  
**flowgram.ai ???**: v1.0.2

---

## 1. ????

### 1.1 ????

Flowgram.ai demo-free-layout ????? React 18 ??????????????????????? flowgram.ai ????????????????

**?????**:
- **React 18** + **TypeScript 5.8+**
- **@flowgram.ai/free-layout-editor**: ?????????
- **@douyinfe/semi-ui**: UI ???
- **Rsbuild**: ????
- **styled-components**: CSS-in-JS

**????**:
```
src/
??? components/          # ????
?   ??? base-node/      # ???????
?   ??? comment/        # ????
?   ??? group/          # ????
?   ??? sidebar/        # ?????????
?   ??? tools/          # ????
??? nodes/              # ?????????
??? plugins/            # ????
??? hooks/              # React Hooks
??? typings/            # TypeScript ????
??? services/           # ???
??? shortcuts/          # ???
??? app.tsx             # ????
??? editor.tsx          # ?????
??? initial-data.ts     # ???????
```

---

## 2. ??????

### 2.1 ?????? (FlowNodeJSON)

**????**: `src/typings/node.ts`

```typescript
export interface FlowNodeJSON extends FlowNodeJSONDefault {
  id: string;                    // ??????
  type: string;                  // ???? (? 'start', 'end', 'llm', 'condition' ?)
  meta: FlowNodeMeta;            // ?????
  data: {
    title?: string;              // ????
    inputsValues?: Record<string, IFlowValue>;  // ?????
    inputs?: JsonSchema;         // ????? JsonSchema ??
    outputs?: JsonSchema;        // ????? JsonSchema ??
    [key: string]: any;          // ???????
  };
  blocks?: FlowNodeJSON[];       // ?????? loop?group ??????
  edges?: WorkflowEdgeJSON[];    // ???????
}
```

**??????**:

1. **meta.position**: 
   ```typescript
   {
     x: number;  // ??????? X ??
     y: number;  // ??????? Y ??
   }
   ```

2. **meta (????)**:
   ```typescript
   {
     position: { x, y };
     sidebarDisabled?: boolean;   // ?????????
     nodePanelHidden?: boolean;   // ????????????
     wrapperStyle?: React.CSSProperties;  // ???????
     defaultExpanded?: boolean;   // ??????
   }
   ```

3. **data ????** (? LLM ????):
   ```typescript
   {
     title: 'LLM_1',
     inputsValues: {
       modelName: { type: 'constant', content: 'gpt-3.5-turbo' },
       apiKey: { type: 'constant', content: 'sk-xxx' },
       temperature: { type: 'constant', content: 0.5 },
       prompt: { type: 'template', content: '# User Input\n...' }
     },
     inputs: {
       type: 'object',
       required: ['modelName', 'apiKey', 'temperature', 'prompt'],
       properties: { ... }
     },
     outputs: {
       type: 'object',
       properties: {
         result: { type: 'string' }
       }
     }
   }
   ```

### 2.2 ?????? (FlowDocumentJSON)

**????**: `src/typings/node.ts`

```typescript
export interface FlowDocumentJSON {
  nodes: FlowNodeJSON[];           // ????
  edges: WorkflowEdgeJSON[];       // ??????
  globalVariable?: JsonSchema;     // ??????
}
```

**??????**:
```typescript
interface WorkflowEdgeJSON {
  sourceNodeID: string;       // ??? ID
  targetNodeID: string;       // ???? ID
  sourcePortID?: string;      // ??? ID???????????
  targetPortID?: string;      // ???? ID????
}
```

**??**:
```typescript
{
  nodes: [
    { id: 'start_0', type: 'start', meta: {...}, data: {...} },
    { id: 'end_0', type: 'end', meta: {...}, data: {...} }
  ],
  edges: [
    { sourceNodeID: 'start_0', targetNodeID: 'end_0' }
  ],
  globalVariable: {
    type: 'object',
    properties: {
      userId: { type: 'string' }
    }
  }
}
```

---

## 3. ??????

### 3.1 ??????? (FlowNodeRegistry)

**????**: `src/typings/node.ts`

```typescript
export interface FlowNodeRegistry extends FlowNodeRegistryDefault {
  type: string;                    // ??????
  meta: FlowNodeMeta;              // ?????
  formMeta?: FormMeta;             // ???????????????
  info?: {
    icon: string;                  // ?????SVG ???????
    description: string;           // ????
  };
  canAdd?: (ctx) => boolean;       // ?????????
  canDelete?: (ctx, from) => boolean;  // ?????????
  onAdd?: (ctx) => FlowNodeJSON;   // ????????
}
```

### 3.2 ??????

**????**: `src/nodes/constants.ts`

```typescript
export enum WorkflowNodeType {
  Start = 'start',           // ????
  End = 'end',               // ????
  LLM = 'llm',               // ???????
  HTTP = 'http',             // HTTP ????
  Code = 'code',             // ??????
  Condition = 'condition',   // ??????
  Loop = 'loop',             // ??????
  Break = 'break',           // ??????
  Continue = 'continue',     // ??????
  Comment = 'comment',       // ????
  Group = 'group',           // ????
  Variable = 'variable',     // ????
  BlockStart = 'block-start', // ??????
  BlockEnd = 'block-end',     // ??????
}
```

### 3.3 ??????

**??**: `src/nodes/start/index.ts`

```typescript
export const StartNodeRegistry: FlowNodeRegistry = {
  type: WorkflowNodeType.Start,
  meta: {
    defaultExpanded: true,
    nodePanelHidden: true,     // ????????
  },
  formMeta: {
    type: WorkflowNodeType.Start,
    items: [
      {
        key: 'title',
        formComponent: 'input',
        label: '????',
        placeholder: '??????',
      },
      {
        key: 'outputs',
        formComponent: 'json-schema-editor',
        label: '????',
      },
    ],
  },
  info: {
    icon: IconStart,
    description: '????????',
  },
  canDelete: () => false,  // ?????????
};
```

---

## 4. ???? (PropertiesPanel / Sidebar)

### 4.1 ??????

**????**: `src/components/sidebar/node-form-panel.tsx`

**????**:
1. **?????**: ?? `@flowgram.ai/panel-manager-plugin` ??????
2. **????**: `nodeFormPanelFactory` ??????????????
3. **?????**: `SidebarNodeRenderer` ?????????????

**????**:
- **??????**: ???? 500px
- **????**: ??????????????????
- **????**: ??????????
- **????**: ?? `startTransition` ????

### 4.2 ?????? (NodeEngine)

**??**: `@flowgram.ai/form-materials` + `formMeta`

**??????**:
```typescript
{
  'input': ?????,
  'textarea': ????,
  'number': ????,
  'select': ????,
  'switch': ??,
  'json-schema-editor': JsonSchema ???,
  'prompt-editor': Prompt ????????,
  'code-editor': ?????,
  'variable-selector': ?????,
}
```

**??????** (`formMeta`):
```typescript
{
  type: 'llm',
  items: [
    {
      key: 'title',
      formComponent: 'input',
      label: '????',
    },
    {
      key: 'inputsValues.modelName',
      formComponent: 'select',
      label: '??',
      options: [
        { label: 'GPT-3.5', value: 'gpt-3.5-turbo' },
        { label: 'GPT-4', value: 'gpt-4' },
      ],
    },
    {
      key: 'inputsValues.prompt',
      formComponent: 'prompt-editor',
      label: 'Prompt',
    },
  ],
}
```

### 4.3 ???????

**??????**: `<IsSidebarContext.Provider>`

????????????????????????????

---

## 5. ?????

### 5.1 ????

**??**: `@flowgram.ai/free-layout-editor` ??

**????**:
- **????**: ???????????????
- **????**: ?? `createFreeSnapPlugin` ????????
- **????**: `ctx.tools.autoLayout()` ???????
- **????**: `ctx.tools.fitView()` ???????????

**????**:
- ????????
- ?????
- ??????????????????

### 5.2 ????? Z-Index

**????**: `createFreeStackPlugin` ????????

```typescript
createFreeStackPlugin({
  sortNodes: (nodes) => {
    const commentNodes = [];
    const otherNodes = [];
    nodes.forEach((node) => {
      if (node.flowNodeType === WorkflowNodeType.Comment) {
        commentNodes.push(node);
      } else {
        otherNodes.push(node);
      }
    });
    return [...commentNodes, ...otherNodes];  // Comment ?????
  },
})
```

### 5.3 ??????

```
Editor Component
  ?
FreeLayoutEditorProvider (?????)
  ?
EditorRenderer (????)
  ?
?????
  ?? BaseNode (???????)
  ?   ?? NodeWrapper (?????)
  ?   ?? Form.render() (??????)
  ?   ?? NodeStatusBar (?????)
  ?
  ?? ????????
      ?? CommentRender (????)
      ?? GroupNodeRender (????)
```

---

## 6. ????

### 6.1 ??????

**????**: `src/hooks/use-editor-props.tsx` ? `plugins` ??

```typescript
plugins: () => [
  // 1. ??????
  createFreeStackPlugin({ sortNodes: ... }),
  
  // 2. ??????
  createFreeLinesPlugin({ renderInsideLine: LineAddButton }),
  
  // 3. ?????
  createMinimapPlugin({ canvasStyle: {...} }),
  
  // 4. ??????????
  createFreeSnapPlugin({ edgeColor: '#00B2B2', ... }),
  
  // 5. ????????
  createFreeNodePanelPlugin({ renderer: NodePanel }),
  
  // 6. ?????? (loop ?????)
  createContainerNodePlugin({}),
  
  // 7. ????
  createFreeGroupPlugin({ groupNodeRender: GroupNodeRender }),
  
  // 8. ??????
  createContextMenuPlugin({}),
  
  // 9. ?????
  createRuntimePlugin({ mode: 'browser' }),
  
  // 10. ??????
  createVariablePanelPlugin({ initialData: ... }),
  
  // 11. ?????????
  createPanelManagerPlugin({ factories: [...] }),
]
```

### 6.2 ??????

**?????**: `FreeLayoutPluginContext`

**???????**:
```typescript
ctx.document        // ???? (toJSON, fromJSON, getNode, addNode, ...)
ctx.selection       // ????
ctx.playground      // ????
ctx.tools           // ???? (autoLayout, fitView, ...)
ctx.history         // ???? (undo, redo)
ctx.get(Service)    // ??????
```

---

## 7. ???????

### 7.1 ????

**????**: `onContentChange` ?? + ???1 ??

```typescript
onContentChange: debounce((ctx, event) => {
  if (ctx.document.disposed) return;
  
  console.log('Auto Save: ', event, {
    ...ctx.document.toJSON(),   // ??????
    globalVariable: ctx.get<GetGlobalVariableSchema>(GetGlobalVariableSchema)(),
  });
}, 1000)
```

**????**: ?? `ctx.document.toJSON()` ??????

### 7.2 ????

**?????**: ?? `initialData` ????

```typescript
<FreeLayoutEditorProvider initialData={initialData} {...otherProps}>
  ...
</FreeLayoutEditorProvider>
```

**????**: ?? `ctx.document.fromJSON(data)` ????

### 7.3 ?????

**????**: JSON (FlowDocumentJSON)

**??????**:
```typescript
// ?????????
fromNodeJSON(node, json) {
  return json;  // ?????????
}

// ?????????
toNodeJSON(node, json) {
  return json;  // ?????????
}
```

---

## 8. ?????

### 8.1 ??????

**???????**:
```typescript
materials: {
  components: {},
  renderDefaultNode: BaseNode,  // ???????
  renderNodes: {
    [WorkflowNodeType.Comment]: CommentRender,  // ????????
  },
}
```

**????**: ?????????? `renderNodes`

### 8.2 ??????

**??? 1**: ???????

?? `formMeta.items[].formComponent` ???????????????????

**??? 2**: ????????

????????????? `createPanelManagerPlugin` ? `factories` ???

### 8.3 ??????

**????**: ???????????

**????**:
1. **????????**: ?? `ctx.document.onNodeChanged` ??
2. **??????**: ?? `node.updateMeta({ position: { x, y } })`
3. **???????**: ?????? flowgram.ai ?? API

### 8.4 ??????

**???**: `data` ??????????????????

**??**: ? spec-kit ???????
```typescript
{
  id: 'node_1',
  type: 'user-story',
  meta: { position: {...} },
  data: {
    title: '???? 1',
    // ????
    inputsValues: {...},
    outputs: {...},
    // ??????spec-kit?
    specKitType: 'user-story',       // spec-kit ??
    priority: 'P1',                   // ???
    storyNumber: 1,                   // ????
    acceptanceCriteria: [...],        // ????
    markdownContent: '## ????\n...',  // ?? Markdown ??
    astNodeRef: {...},                // AST ????
  }
}
```

---

## 9. ?? API ??

### 9.1 ???? API

```typescript
ctx.document.toJSON(): FlowDocumentJSON       // ????
ctx.document.fromJSON(data): void             // ????
ctx.document.getNode(id): FlowNodeEntity      // ????
ctx.document.addNode(json): FlowNodeEntity    // ????
ctx.document.deleteNode(id): void             // ????
ctx.document.addEdge(edge): void              // ????
ctx.document.deleteEdge(id): void             // ????
ctx.document.onNodeChanged(callback): Disposable  // ??????
```

### 9.2 ???? API

```typescript
node.updateData(data): void                   // ??????
node.updateMeta(meta): void                   // ???????
node.getNodeMeta<T>(): T                      // ???????
node.getNodeRegistry(): FlowNodeRegistry      // ???????
node.lines.allInputNodes: FlowNodeEntity[]    // ??????
node.lines.allOutputNodes: FlowNodeEntity[]   // ??????
node.parent?: FlowNodeEntity                  // ???????
node.onDispose(callback): Disposable          // ??????
```

### 9.3 ???? API

```typescript
ctx.tools.autoLayout(): void                  // ????
ctx.tools.fitView(animated?: boolean): void   // ????
ctx.selection.select(nodes): void             // ????
ctx.history.undo(): void                      // ??
ctx.history.redo(): void                      // ??
```

---

## 10. ??????

### 10.1 ????

- **?????**: ??????????????????
- **????**: `debounce(1000)` ??????
- **????**: `startTransition` ??????

### 10.2 ????

- **????**: ?? `node.updateData()` ??????
- **????**: ? `data.astNodeRef` ????????????????

### 10.3 ??????

- **?????**: `history.enableChangeNode` ????????????
- **????**: ?? `ctx.history.batch()` ??????

---

## 11. Spec-Kit ????

### 11.1 Markdown ? Flowgram ????

| Markdown ?? | Flowgram ???? | ???? |
|--------------|-----------------|--------|
| `# ??` | ????? `'heading'` | `data.title = ????`<br/>`data.level = 1` |
| `## ???` | ????? `'heading'` | `data.level = 2` |
| `### ???? N` | ????? `'user-story'` | `data.storyNumber = N`<br/>`data.specKitType = 'user-story'` |
| `- [ ] ??` | ????? `'task'` | `data.checked = false`<br/>`data.specKitType = 'task'` |
| ???? | `data.markdownContent` | ???? Markdown |

### 11.2 ??????

**????**:
```
???????????????????????????????????
? ?? [P1] ???? 1 - ??         ?  ? ?????? + ??? + ???
???????????????????????????????????
? ????????????...      ?  ? ?????? 2-3 ??
? ??...                         ?
???????????????????????????????????
? ?? 123 ? | ? 2???           ?  ? ??????? + ?????
???????????????????????????????????
```

**????**: ??? `renderNodes['user-story']` ??

### 11.3 TipTap ????

**??**: ?? `nodeFormPanelFactory` ?????????

**????**:
1. ????????? spec-kit ??
2. ?????? TipTap ?????????
3. ?????
   - **Markdown ? TipTap**: ?? `tiptap-markdown` ??
   - **TipTap ? Markdown**: ?????????? `node.updateData()`
4. ?????1 ??? + `node.updateData()`

### 11.4 ????????

**?? 1**: ?????????

?? `createMindmapLayoutPlugin`???????/????????????

**?? 2**: ???

? `fromNodeJSON` ?????????????????

**??????**:
```typescript
function calculateMindmapPosition(node, parent, siblingIndex) {
  const level = parent ? parent.level + 1 : 0;
  const x = level * 300;  // ???? 300px
  const y = siblingIndex * 100;  // ???? 100px
  return { x, y };
}
```

---

## 12. ???????

### 12.1 ???????

- **flowgram.ai ????**: ???? `id`, `type`, `meta`, `data`
- **????????**: ???????????????????

### 12.2 ????

- **???**: ?? 500 ?????????????????
- **?? AST**: ??? `data` ?????? AST ???????????

### 12.3 ????

- **????**: ???????????? `plugins` ????
- **????**: ????????????????

---

## 13. ????

- **flowgram.ai ????**: https://flowgram.ai/
- **GitHub ??**: https://github.com/bytedance/flowgram.ai
- **npm ?**: https://www.npmjs.com/org/flowgram.ai

---

**????**: ???????? flowgram.ai demo-free-layout ??????????????????????? Spec-Kit Flow ????????????

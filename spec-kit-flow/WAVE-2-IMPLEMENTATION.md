# Wave 2: Tauri ??? - ????

## ??

??????? specs/001-visual-flow-foundation ? Wave 2 ??????
- ? Task 5.1: ??? Tauri ??
- ? Task 5.2: ?????????Rust?
- ? Task 5.3: ?????????Rust?
- ? Task 5.4: ???? Tauri API
- ? Task 5.5: ????????
- ? Task 5.6: ?????????P2?
- ? Task 5.7: ?? AI ???????P2?

## ????

### Rust ???Tauri?

```
src-tauri/
??? src/
?   ??? main.rs                    # ??????????
?   ??? fs_commands.rs             # ????????/?/???
?   ??? watcher.rs                 # ???????notify crate?
??? Cargo.toml                     # Rust ????
??? tauri.conf.json                # Tauri ????
```

### ???TypeScript + React?

```
src/
??? services/
?   ??? fileSystem.ts              # ???????Task 5.4, 5.5?
??? hooks/
?   ??? useConflictDetection.ts    # ???? hook?Task 5.6?
?   ??? useAIGenerationDetection.ts # AI ???? hook?Task 5.7?
??? components/
?   ??? conflict/
?       ??? ConflictDialog.tsx     # ???????
?       ??? ConflictDialog.css     # ?????
?       ??? index.ts               # ??
??? styles/
?   ??? ai-generation.css          # AI ??????
??? examples/
    ??? TauriIntegrationExample.tsx # ????
```

## ??????

### 1. ???????Task 5.1-5.4?

#### Rust ??

```rust
// src-tauri/src/fs_commands.rs

// ?? Markdown ??
pub fn read_markdown_file(path: String) -> Result<String, String>

// ?? Markdown ??
pub fn write_markdown_file(path: String, content: String) -> Result<(), String>

// ?? Markdown ?????????
pub async fn select_markdown_file() -> Result<Option<String>, String>
```

#### ????

```typescript
import { fileSystemService } from './services/fileSystem';

// ????
const filePath = await fileSystemService.selectFile();

// ????
const content = await fileSystemService.readFile(filePath);

// ????
await fileSystemService.writeFile(filePath, content);

// ??????
const unlisten = await fileSystemService.watchFile(filePath, (event) => {
  console.log('File changed:', event);
});
```

### 2. ???????Task 5.5?

**??**: ???? ? ???? ? ?????? ? ???? ? ??????

**????**: ?????????/????

```typescript
// src/services/fileSystem.ts

let isInternalSave = false;

async writeFile(path: string, content: string) {
  isInternalSave = true;  // ???????
  await invoke('write_markdown_file', { path, content });
  setTimeout(() => { isInternalSave = false; }, 1000); // 1 ????
}

async watchFile(path: string, callback: (event) => void) {
  await listen('file-changed', (event) => {
    if (isInternalSave) {
      console.log('Internal save, skipping reload');
      return; // ???????????
    }
    callback(event); // ???????
  });
}
```

### 3. ???????Task 5.6, P2 ???

**??**: ??????? + ????????

**????**: ??????????????

```typescript
import { useConflictDetection } from './hooks/useConflictDetection';

const {
  hasUnsavedChanges,      // ????????
  conflictState,          // ????
  handleContentChange,    // ???????
  handleSaveSuccess,      // ???????
  handleFileChanged,      // ??????
  handleKeepLocal,        // ??????
  handleLoadExternal,     // ??????
} = useConflictDetection(currentFilePath);

// ???????
handleContentChange(newContent);

// ???????
handleSaveSuccess(savedContent);

// ??????
fileSystemService.watchFile(filePath, async (event) => {
  const externalContent = await handleFileChanged(event, () => getCurrentContent());
  if (externalContent) {
    // ????????
    loadContent(externalContent);
  }
  // ????????????
});
```

**?????**:

```tsx
{conflictState?.showDialog && (
  <ConflictDialog
    localContent={conflictState.localContent}
    externalContent={conflictState.externalContent}
    lastSavedContent={conflictState.lastSavedContent}
    onKeepLocal={() => handleKeepLocal(localContent)}
    onLoadExternal={() => handleLoadExternal(externalContent)}
    onCancel={handleCancelConflict}
  />
)}
```

### 4. AI ???????Task 5.7, P2 ???

**????**: 3 ?? > 3 ????? = AI ????

**??**:

```typescript
import { useAIGenerationDetection } from './hooks/useAIGenerationDetection';

const { 
  aiGeneratingPaths,    // ???????????
  detectAIGeneration,   // ?? AI ??
  isAIGenerating,       // ??????????
} = useAIGenerationDetection();

// ??????
fileSystemService.watchFile(filePath, (event) => {
  const isAI = detectAIGeneration(event);
  
  if (isAI) {
    // ??"???"??
    console.log('AI is generating...');
    return; // ?????
  }
  
  // ????????
  reloadFile();
});

// ??????????
if (isAIGenerating(filePath)) {
  // ???? UI??????
}
```

**????**:

```css
/* src/styles/ai-generation.css */

/* ?????? */
.node-card.ai-generating {
  border: 2px solid #1890ff;
  animation: pulse-border 1.5s infinite;
}

/* ???? */
.ai-badge {
  background: #1890ff;
  animation: pulse-badge 1.5s infinite;
}

/* ???? */
.node-content.locked {
  pointer-events: none;
  opacity: 0.6;
}
```

## ????

?????????? `src/examples/TauriIntegrationExample.tsx`

## ????

### ????

```bash
# ?? Tauri ????????????????
npm run tauri:dev
```

### ??????

```bash
# ??????
npm run build:prod

# ?? Tauri ???macOS: .dmg, Windows: .msi, Linux: .deb?
npm run tauri:build
```

## ????

?? tasks.md Phase 5 ? Checkpoint?

- ? Tauri ???????tauri.conf.json ?????
- ? Rust ??????????read/write/select?
- ? ??????????notify crate?
- ? ?? fileSystem.ts ?????
- ? ????????????isInternalSave ????
- ? ??????????ConflictDialog + useConflictDetection?
- ? AI ??????????useAIGenerationDetection + ?????

## ????

### Rust ??

```toml
[dependencies]
tauri = { version = "1.8.1", features = ["dialog-all", "fs-all", "shell-open"] }
notify = "6.1"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
```

### TypeScript ??

?? package.json ????
- `@tauri-apps/api`: Tauri ?? API
- `@tauri-apps/cli`: Tauri CLI ??

### ??????

```json
// src-tauri/tauri.conf.json
{
  "tauri": {
    "allowlist": {
      "fs": {
        "all": true,
        "scope": ["$HOME/**/*.md", "$APPDATA/**/*.md"]
      },
      "dialog": {
        "all": true,
        "open": true,
        "save": true
      }
    }
  }
}
```

## ???

Wave 2 ???????? Wave 3 ????
- Agent-4: ???? + ????
- Agent-5: TipTap ??????
- Agent-7: ????????

??? Wave 2 ?????????

## ????

1. **??????**: notify crate ????????????????? 100-500ms
2. **AI ????**: ????? 3 ?? > 3 ?????????????
3. **????**: ???????????????????????
4. **??????**: 1 ????????????????????????

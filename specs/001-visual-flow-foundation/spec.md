# 功能规格: Spec-Kit Flow 核心可视化框架

**功能分支**: `001-visual-flow-foundation`  
**创建时间**: 2025-10-31  
**状态**: 草案  
**输入**: 建立 Spec-Kit Flow 的核心可视化框架 - 基于自由布局流程图的可视化界面，用于展示和编辑 spec-kit 项目文档

## 用户场景与测试（必填）

### 用户故事 1 - 自由布局可视化文档结构（优先级：P1）

作为 spec-kit 用户，我希望在可视化流程图中看到项目的所有文档（constitution、specs、plans、tasks），并能够自由拖拽布局，以便我能以自己习惯的方式组织和理解项目结构。

**为何该优先级**: 这是整个系统的基础，没有可视化展示就无法进行后续的编辑、同步等操作。基于 flowgram.ai 的自由布局是核心差异化功能，必须优先实现。

**独立测试**: 打开一个包含 spec-kit 文档的项目目录，系统应自动扫描并显示所有文档节点，用户可以拖拽节点到任意位置，刷新后布局保持不变。这个功能可以独立交付价值，让用户直观了解项目结构。

**验收场景**:

1. **给定** 一个包含 constitution.md、specs/001-feature/spec.md、plan.md、tasks.md 的项目，**当** 用户打开应用并选择项目目录，**则** 系统自动扫描并显示所有文档节点，节点之间用连线表示层级关系
2. **给定** 显示的流程图，**当** 用户拖拽任意节点到新位置，**则** 节点位置立即更新，连线自动调整，布局信息自动保存到本地配置文件
3. **给定** 已保存的布局配置，**当** 用户关闭并重新打开项目，**则** 所有节点恢复到之前保存的位置
4. **给定** 大型项目（50+ 节点），**当** 用户缩放（Ctrl+滚轮）和平移（拖拽画布），**则** 操作流畅无卡顿，帧率保持在 60fps 以上
5. **给定** 自由布局的画布，**当** 用户双击空白区域，**则** 显示节点快捷添加菜单

---

### 用户故事 2 - Markdown 内容编辑与预览（优先级：P1）

作为文档编写者，我希望点击节点后能直接查看和编辑 Markdown 内容，并实时预览渲染效果，以便我可以在可视化界面中完成所有文档编辑工作，无需切换到外部编辑器。

**为何该优先级**: 编辑功能是可视化工具的核心价值，用户需要能够直接在界面中修改内容。与 P1 的可视化展示同等重要，构成 MVP 的两大核心功能。

**独立测试**: 点击任意文档节点，打开编辑面板，修改 Markdown 内容并保存，文件系统中的对应 .md 文件应同步更新。这个功能可以独立测试，并直接带来编辑效率提升的价值。

**验收场景**:

1. **给定** 流程图中的任意文档节点，**当** 用户点击节点，**则** 右侧打开编辑面板，显示文档的 Markdown 源码和实时预览（分栏显示）
2. **给定** 打开的编辑面板，**当** 用户修改 Markdown 内容，**则** 右侧预览实时更新渲染效果，无需手动刷新
3. **给定** 已修改的内容，**当** 用户按 Ctrl+S 或点击保存按钮，**则** 内容立即写入对应的 .md 文件，节点显示保存成功提示
4. **给定** 编辑中的文档，**当** 用户按 Ctrl+Z/Ctrl+Y，**则** 支持多级撤销和重做操作
5. **给定** 编辑面板，**当** 用户使用 Markdown 语法（如 `# 标题`、`**粗体**`、代码块），**则** 提供语法高亮和智能补全（如自动匹配括号、引号）

---

### 用户故事 3 - 文档节点的增删管理（优先级：P2）

作为项目管理者，我希望能够在可视化界面中新增和删除文档节点，系统自动创建或删除对应的 .md 文件，以便我可以完全在可视化工具中管理项目文档结构。

**为何该优先级**: 虽然重要，但用户可以先通过外部方式（文件浏览器）创建/删除文件，系统自动检测更新。此功能提升便利性，但不阻碍核心工作流。

**独立测试**: 右键点击画布或父节点，选择"新增文档"，填写文档类型和名称，系统创建对应文件并显示新节点。删除节点时弹出确认对话框，确认后文件被移除。

**验收场景**:

1. **给定** 流程图画布，**当** 用户右键点击 constitution 节点，选择"新增 Spec"，填写特性名称"user-auth"，**则** 系统在 specs/ 目录下创建 002-user-auth/ 文件夹和 spec.md 文件，并在流程图中显示新节点
2. **给定** 新创建的节点，**当** 系统创建文件后，**则** 节点自动链接到父节点（constitution），连线清晰可见
3. **给定** 流程图中的任意节点，**当** 用户右键选择"删除"并确认，**则** 对应的 .md 文件被移动到回收站（而非永久删除），节点从流程图中移除
4. **给定** 删除操作，**当** 用户在确认对话框中取消，**则** 节点和文件保持不变
5. **给定** 新增节点操作，**当** 节点名称与已有节点冲突，**则** 显示错误提示，不允许创建重复节点

---

### 用户故事 4 - AI 执行状态实时同步（优先级：P2）

作为使用 AI 辅助开发的用户，我希望可视化界面能够实时显示 AI 当前正在处理的文档节点（如正在生成 plan.md），并在 AI 完成后自动刷新节点内容，以便我能够直观了解 AI 的工作进度和结果。

**为何该优先级**: 这是与 AI 集成的核心功能，但可以在基础可视化和编辑功能稳定后再实现。用户可以先手动刷新查看 AI 生成的内容。

**独立测试**: 在 AI 执行 `/speckit.plan` 命令时，系统检测到 plan.md 文件变化，对应节点高亮显示"AI 生成中"状态，文件生成完成后节点恢复正常并显示"已更新"标记。

**验收场景**:

1. **给定** AI 正在执行 spec-kit 命令（如 `/speckit.plan`），**当** 系统检测到相关文件正在被写入，**则** 对应节点显示"生成中"状态（如脉冲动画、特殊图标）
2. **给定** AI 完成文件生成，**当** 文件写入完成，**则** 节点状态恢复正常，显示"已更新"徽章（3 秒后自动消失）
3. **给定** AI 生成过程中，**当** 用户点击正在生成的节点，**则** 显示实时日志或进度提示（如"正在研究技术栈..."）
4. **给定** 多个文档同时被 AI 更新，**当** 更新完成后，**则** 所有相关节点同时刷新内容
5. **给定** 文件系统监控，**当** 外部编辑器或 AI 修改了文件，**则** 系统在 500ms 内检测到变化并更新对应节点内容

---

### 用户故事 5 - 内容更新后触发 AI 校验（优先级：P3）

作为质量把控者，我希望在编辑完文档内容后，能够手动或自动触发 AI 对内容进行校验（如检查 spec.md 是否符合模板规范、plan.md 是否与 spec.md 一致），并在节点上显示校验结果，以便我能够及时发现和修正问题。

**为何该优先级**: 这是增强功能，可以提升质量，但不是核心工作流的必需品。用户可以先通过 `/speckit.analyze` 命令手动校验。

**独立测试**: 编辑 spec.md 后点击节点右键菜单的"AI 校验"，系统调用 AI 分析内容，返回校验结果（如"缺少成功标准部分"），在节点上显示警告图标。

**验收场景**:

1. **给定** 用户编辑完 spec.md 并保存，**当** 用户右键点击节点选择"AI 校验"，**则** 系统调用 AI 分析内容，返回校验结果（如"✓ 符合规范"或"⚠️ 缺少功能需求部分"）
2. **给定** 校验结果包含问题，**当** 结果返回后，**则** 节点显示警告图标，点击图标展开详细问题列表
3. **给定** 校验问题列表，**当** 用户点击某个问题（如"缺少成功标准"），**则** 自动打开编辑面板并定位到对应部分
4. **给定** 用户设置了自动校验选项，**当** 保存文档后，**则** 系统自动触发 AI 校验（后台执行，不阻塞用户操作）
5. **给定** 多个文档需要校验，**当** 用户选择"批量校验所有文档"，**则** 系统按顺序校验所有节点，在流程图上显示总体健康度评分

---

### 用户故事 6 - CLI 工具集成框架（优先级：P3）

作为高级用户，我希望能够在可视化界面中直接调用 spec-kit 的命令（如 `/speckit.specify`、`/speckit.plan`），并将执行结果反映到流程图中，以便我可以在一个统一的界面中完成从规范到实现的全流程。

**为何该优先级**: 这是便利性功能，用户可以先在终端或 IDE 中执行 spec-kit 命令，系统通过文件监控自动更新界面。集成后可以提升用户体验，但不是 MVP 必需。

**独立测试**: 在应用内打开命令面板（Ctrl+Shift+P），输入 `/speckit.plan`，系统在后台执行命令，并实时显示执行日志，完成后自动刷新流程图。

**验收场景**:

1. **给定** 用户按下 Ctrl+Shift+P，**当** 输入 `/speckit.plan`，**则** 打开命令执行面板，显示可用的 spec-kit 命令列表（带智能提示）
2. **给定** 用户选择某个命令（如 `/speckit.tasks`），**当** 命令开始执行，**则** 显示实时日志输出，相关节点高亮显示"执行中"状态
3. **给定** 命令执行完成，**当** 生成的文件被写入，**则** 流程图自动刷新显示新节点或更新内容，执行面板显示"✓ 完成"
4. **给定** 命令执行失败，**当** 返回错误信息，**则** 显示错误详情（如缺少前置文件），并提供修复建议（如"请先创建 spec.md"）
5. **给定** 支持的 CLI 工具列表（spec-kit、claude、gemini 等），**当** 用户配置工具路径后，**则** 可以在命令面板中调用所有已配置的工具

---

### 边界情况

- **当文件系统权限不足时**：无法读取/写入文件时，显示明确的权限错误提示，并提供解决建议（如"请以管理员身份运行"或"检查文件夹权限"）
- **当文件正在被其他程序占用时**：保存失败时显示"文件被占用"错误，提供重试或另存为选项
- **当项目目录包含非 spec-kit 文件时**：仅扫描和显示符合 spec-kit 规范的文件（constitution.md、specs/*/spec.md 等），忽略其他文件
- **当 .md 文件格式损坏或包含无效语法时**：在节点上显示"解析失败"警告，编辑面板显示原始内容，允许用户修复
- **当网络断开或 AI 服务不可用时**：AI 相关功能（校验、执行命令）显示"离线模式"提示，基础编辑和布局功能不受影响
- **当用户快速连续保存时**：防抖处理，避免频繁写入文件系统，合并短时间内的多次保存操作
- **当布局配置文件损坏时**：使用默认布局算法自动排列节点，提示用户"布局配置已重置"
- **当删除有子节点的文档时**：显示警告"该文档有 N 个子文档，是否一并删除？"，用户可选择仅删除当前文档或级联删除

## 需求（必填）

### 功能性需求

#### 自由布局可视化引擎

- **FR-001**: 系统必须基于 flowgram.ai 的自由布局算法实现流程图引擎（不使用 ReactFlow 等第三方库），支持节点的任意位置拖拽和画布缩放/平移
- **FR-002**: 系统必须扫描项目目录，自动识别 spec-kit 文档结构（constitution.md、specs/*/spec.md、plan.md、tasks.md），并将其转换为可视化节点
- **FR-003**: 节点必须显示文档类型（constitution/spec/plan/tasks）、标题、状态（草稿/已完成/AI 生成中），并用不同颜色/图标区分
- **FR-004**: 系统必须在节点之间绘制连线，清晰表达层级关系（constitution → specs → plan → tasks）
- **FR-005**: 系统必须将用户的布局配置（节点坐标、缩放级别、画布偏移）持久化到本地文件（如 `.spec-kit-flow/layout.json`）

#### Markdown 编辑与预览

- **FR-006**: 系统必须提供 Markdown 编辑器，支持语法高亮、智能补全（括号匹配、引号配对）、多级撤销/重做
- **FR-007**: 系统必须实时渲染 Markdown 预览，支持所有 CommonMark 语法（标题、列表、代码块、表格、链接、图片等）
- **FR-008**: 用户保存编辑内容时，系统必须立即写入对应的 .md 文件，并在 500ms 内显示保存成功反馈
- **FR-009**: 系统必须检测编辑冲突（如文件被外部修改），提示用户选择"保留本地修改"或"加载外部更改"
- **FR-010**: 编辑器必须支持键盘快捷键（Ctrl+S 保存、Ctrl+Z 撤销、Ctrl+F 查找、Ctrl+H 替换）

#### 文档节点管理

- **FR-011**: 用户必须能够通过右键菜单或快捷键在画布中新增文档节点，系统自动创建对应的文件夹和 .md 文件
- **FR-012**: 新增 spec 节点时，系统必须自动分配编号（如 001、002），并创建规范的目录结构（specs/001-feature-name/）
- **FR-013**: 删除节点时，系统必须将文件移动到回收站（而非永久删除），并记录删除操作到日志中
- **FR-014**: 系统必须验证节点名称的唯一性，防止创建重复的文档节点
- **FR-015**: 用户必须能够重命名节点，系统自动同步修改文件名和文件夹名（保持编号不变）

#### AI 集成与同步

- **FR-016**: 系统必须实时监控文件系统变化（使用 file watcher），在 500ms 内检测到文件创建/修改/删除事件
- **FR-017**: 当检测到文件变化时，系统必须自动刷新对应节点的内容和状态，无需用户手动刷新
- **FR-018**: 系统必须识别 AI 正在写入的文件（如文件大小持续增长），在节点上显示"生成中"动画
- **FR-019**: 用户必须能够手动触发 AI 校验（右键菜单），系统调用 AI 分析内容并返回结构化的校验结果
- **FR-020**: 校验结果必须包含问题级别（错误/警告/建议）、问题描述、定位信息（行号或章节），并在节点上显示汇总图标

#### CLI 工具集成

- **FR-021**: 系统必须提供命令面板（Ctrl+Shift+P），列出所有可用的 spec-kit 命令（/speckit.specify、/speckit.plan 等）
- **FR-022**: 用户执行命令时，系统必须在后台调用 CLI 工具（如 `claude` 或 `cursor-agent`），并实时显示执行日志
- **FR-023**: 命令执行过程中，系统必须锁定相关节点（禁止编辑），并显示进度指示器
- **FR-024**: 命令执行完成后，系统必须解析输出结果，自动刷新流程图并跳转到新创建或更新的节点
- **FR-025**: 系统必须支持配置多种 CLI 工具的路径（spec-kit、claude、gemini、cursor-agent 等），并允许用户选择默认工具

### 关键实体

- **文档节点（Document Node）**: 代表一个 spec-kit 文档（constitution、spec、plan、tasks），包含属性：类型（type）、标题（title）、文件路径（filePath）、状态（status: draft/completed/ai-generating）、位置坐标（x, y）、最后修改时间（lastModified）
- **连接线（Edge）**: 表达节点之间的层级关系，包含属性：源节点 ID（sourceId）、目标节点 ID（targetId）、连接类型（type: parent-child）
- **布局配置（Layout Config）**: 保存用户的布局偏好，包含属性：节点坐标映射（nodePositions: {nodeId: {x, y}}）、画布缩放级别（zoom）、画布偏移（pan: {x, y}）
- **校验结果（Validation Result）**: AI 校验返回的结构化数据，包含属性：文档路径（filePath）、问题列表（issues: [{level, message, location}]）、整体评分（score）
- **命令执行记录（Command Execution）**: CLI 命令的执行历史，包含属性：命令名称（command）、参数（args）、开始时间（startTime）、结束时间（endTime）、状态（status: running/completed/failed）、输出日志（logs）

## 成功标准（必填）

### 可度量结果

- **SC-001**: 用户能够在 5 分钟内完成从打开项目到可视化查看所有文档的完整流程（包括首次设置）
- **SC-002**: 系统在加载包含 50 个节点的项目时，初始渲染时间小于 2 秒，拖拽节点时帧率保持在 60fps
- **SC-003**: 用户编辑 Markdown 文档并保存后，文件系统中的 .md 文件在 500ms 内完成写入，界面显示保存成功反馈
- **SC-004**: 当 AI 生成新文档时（如执行 `/speckit.plan`），系统在文件创建后 1 秒内检测到变化并刷新流程图
- **SC-005**: 90% 的用户在首次使用时，无需查看文档即可完成基础操作（拖拽节点、点击编辑、保存内容）
- **SC-006**: 系统在离线模式下（AI 服务不可用），所有本地编辑和布局功能正常工作，无崩溃或功能降级
- **SC-007**: 用户通过命令面板执行 spec-kit 命令时，实时日志显示延迟小于 200ms，命令执行成功率 > 95%
- **SC-008**: 用户配置 CLI 工具路径后，系统能够在 3 秒内验证工具可用性并显示结果（成功/失败/未找到）

### 用户体验指标

- **UX-001**: 界面布局清晰，左侧为流程图画布，右侧为编辑面板，用户能够一眼识别核心功能区域
- **UX-002**: 节点拖拽时提供平滑的视觉反馈（拖拽影子、连线实时调整），用户感觉操作自然流畅
- **UX-003**: 所有异步操作（保存、AI 校验、命令执行）都提供明确的进度指示（加载动画、进度条、实时日志）
- **UX-004**: 错误提示友好且可操作，不仅告知问题（如"保存失败"），还提供解决方案（如"请检查文件权限"或"重试"按钮）
- **UX-005**: 键盘导航完整，用户可以仅通过键盘完成所有核心操作（Tab 切换焦点、Enter 确认、Esc 取消、快捷键触发功能）

## 假设与依赖（必填）

### 假设

- **A-001**: 用户的项目已经使用 spec-kit 方法论进行初始化，包含标准的目录结构（.specify/、specs/、memory/ 等）
- **A-002**: 用户使用的操作系统（macOS/Windows/Linux）支持文件系统监控 API（如 macOS 的 FSEvents、Windows 的 ReadDirectoryChangesW、Linux 的 inotify）
- **A-003**: 用户已经安装了至少一种 AI CLI 工具（如 claude、cursor-agent、gemini），并配置了 API 密钥
- **A-004**: 用户的硬件性能满足基本要求（4GB+ 内存、支持 WebGL 的显卡），能够流畅运行基于 Electron/Tauri 的桌面应用
- **A-005**: 项目中的 .md 文件遵循 UTF-8 编码，文件大小不超过 10MB（单个文件）
- **A-006**: 用户网络环境允许访问 AI 服务（如果使用云端 AI），或本地已部署 AI 模型

### 依赖

- **D-001**: flowgram.ai 的自由布局算法实现（需要研究其开源代码并移植到项目中，或基于其设计思想自行实现）
- **D-002**: 文件系统监控库（如 chokidar for Node.js，或 Tauri 提供的 Rust notify crate）
- **D-003**: Markdown 解析和渲染库（如 CodeMirror 6 for editing、react-markdown + remark/rehype plugins for preview）
- **D-004**: AI CLI 工具的可用性和稳定性（claude、cursor-agent、gemini 等，需要用户自行安装和配置）
- **D-005**: 跨平台桌面应用框架（Tauri 或 Electron，基于项目宪章的轻量级要求，优先选择 Tauri）
- **D-006**: 本地存储机制（如 localStorage、IndexedDB 或文件系统），用于保存布局配置和用户偏好

## 范围外（Out of Scope）

- **OS-001**: 本版本不支持 Git 集成（分支管理、提交历史、合并冲突解决），用户需要在外部 Git 工具中完成这些操作
- **OS-002**: 本版本不支持多用户协作（实时协作编辑、冲突解决、权限管理），仅支持单用户本地编辑
- **OS-003**: 本版本不支持云存储和跨设备同步，所有数据仅保存在本地文件系统
- **OS-004**: 本版本不提供自定义 AI 模型训练或微调功能，仅集成现有的 AI CLI 工具
- **OS-005**: 本版本不支持移动端（iOS/Android），仅支持桌面平台（macOS/Windows/Linux）
- **OS-006**: 本版本不提供高级图表生成（如从 spec 自动生成 UML 图、数据流图），仅支持基础的文档节点可视化
- **OS-007**: 本版本不支持插件系统或扩展 API，功能范围限定在本规范定义的核心功能内

## 审查与验收检查清单

### 规范质量

- [ ] 规范中无具体技术实现细节（React/Tauri 等仅作为技术期望，未出现在需求中）
- [ ] 所有用户故事关注用户价值和业务需求，而非技术实现
- [ ] 所有用户故事可以独立测试和交付价值
- [ ] 优先级划分合理（P1 是 MVP 必需，P2/P3 是增强功能）

### 需求完整性

- [ ] 无未解决的 [需要澄清] 标记（本规范根据用户输入和常识已完成所有合理推断）
- [ ] 所有功能性需求（FR-001 到 FR-025）清晰、可测试、可实现
- [ ] 所有验收场景明确定义了初始状态、操作和期望结果
- [ ] 边界情况已充分识别并定义了系统行为
- [ ] 范围外（Out of Scope）明确界定，避免范围蔓延

### 需求一致性

- [ ] 用户故事与功能性需求一致（每个故事的验收场景都对应明确的 FR）
- [ ] 成功标准与用户故事一致（可度量结果覆盖所有核心用户旅程）
- [ ] 关键实体与功能需求一致（所有 FR 中提到的数据概念都在实体中定义）
- [ ] 假设与依赖清晰列出，无隐含的技术假设

### 与宪章对齐

- [ ] 符合"规范驱动优先"原则（严格遵循 spec-kit 文件结构和约定）
- [ ] 符合"视觉清晰度"原则（基于自由布局的直观 UI）
- [ ] 符合"AI 集成"原则（实时同步、内容校验、CLI 工具集成）
- [ ] 符合"开发者体验"原则（键盘导航、快捷键、友好错误提示）
- [ ] 符合"可维护性"原则（功能模块化、清晰的实体定义）
- [ ] 符合技术约束（React/TypeScript、基于 flowgram.ai 自由布局、事件驱动、文件系统为数据源）
- [ ] 符合性能要求（初始加载 < 2秒、实时更新 < 100ms、支持 100+ 节点）
- [ ] 符合质量标准（所有需求可测试、键盘导航支持、WCAG 2.1 AA 友好的界面设计）

### 可测试性

- [ ] 每个验收场景都可以转换为自动化测试用例
- [ ] 每个成功标准都有明确的度量方法（时间、帧率、成功率等）
- [ ] 边界情况都有预期的系统行为，可以编写对应的测试用例
- [ ] 所有 FR 都可以通过单元测试或集成测试验证

### 完整性验证

- [ ] 所有强制性部分（用户场景、需求、成功标准、假设与依赖）都已完成
- [ ] 用户故事覆盖所有核心功能（可视化、编辑、节点管理、AI 同步、CLI 集成）
- [ ] 功能性需求涵盖所有用户故事的验收场景
- [ ] 成功标准既包含可度量结果（定量），也包含用户体验指标（定性）

---

## 下一步行动

1. **评审本规范**: 与团队或利益相关者评审，确认用户故事优先级和功能范围是否合理
2. **澄清剩余问题**（如有）: 本规范根据用户输入已完成合理推断，如有特殊需求或约束，请使用 `/speckit.clarify_cn` 命令进一步澄清
3. **创建技术实施计划**: 使用 `/speckit.plan_cn` 命令，明确技术栈、架构设计和实施阶段划分
4. **生成任务分解**: 使用 `/speckit.tasks_cn` 命令，将实施计划分解为可执行的任务列表
5. **执行实现**: 使用 `/speckit.implement_cn` 命令，按照任务列表逐步实现功能

---

**规范状态**: ✅ 已完成，可以进入规划阶段

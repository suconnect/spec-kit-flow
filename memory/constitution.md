# Spec-Kit Flow - 项目宪章

## 项目愿景

Spec-Kit Flow 是一个**内容结构可视化工具**，将 Spec-Kit 方法论中的 Markdown 文档转换为交互式思维导图。通过解析文档的层级结构（标题、段落、列表），使团队能够以可视化方式理解、编辑和管理规范内容。

**核心差异化**：不仅仅展示文件，而是**理解并可视化文档内容的语义结构**。

## 核心原则

### 1. 内容结构驱动
- **解析 Markdown 层级**：将 `#`、`##`、`###` 等标题转换为节点层级
- **语义理解**：识别用户故事、验收标准、需求等 spec-kit 特定结构
- **动态更新**：内容变化时，节点结构自动重新解析和渲染

### 2. 思维导图式交互
- **从左到右布局**：根节点（文档标题）在左，子节点向右延伸
- **自由拖拽**：用户可以调整节点位置以适应个人思维方式
- **折叠/展开**：支持折叠子树，聚焦关键信息
- **基于 flowgram.ai**：充分利用其自由布局和交互特性

### 3. 双向编辑（面向非技术人员）

#### 编辑交互流程（简化统一）

**主要编辑方式：点击节点 → 右侧面板展开**

1. **点击节点卡片** → 右侧配置面板自动滑出
   - 面板显示：完整内容的富文本编辑器（TipTap）
   - 工具栏提供：[B] [I] [标题▼] [•] [1.] [[ ]] [<>] 等格式化按钮
   - 所见即所得（WYSIWYG）：无需了解 Markdown 语法
   
2. **标题快捷编辑**（便捷功能）
   - 鼠标悬停在卡片标题文字 → 出现编辑图标（✏️）
   - 单击标题区域 → 进入 inline 编辑模式（快速修改标题）
   - 按 Enter 保存，Esc 取消
   - 适用：仅修改标题时的快捷方式

**交互示意**：
```
Step 1: 点击卡片
┌─────────────────┬──────────────────────────┐
│                 │ 🎨 节点配置              │
│   Canvas        │ [B][I][H▼][•][1.][<>]   │
│   (卡片选中)    │ ─────────────────────── │
│                 │  富文本编辑器            │
│                 │  (TipTap，完整内容)      │
└─────────────────┴──────────────────────────┘

Step 2 (可选): 悬停标题 → 单击快捷编辑
卡片标题: [自由布局可视化文档结构 ✏️] ← 悬停显示
           ↓ 单击
          [自由布局可视化文档结构▊] ← inline 编辑
```

#### 节点卡片展示
- **核心信息**：图标、标题、优先级标记（P1/P2/P3）
- **元数据**：状态（草稿/完成）、修改时间、字数统计
- **内容预览**：显示前 2-3 行内容摘要
- **交互反馈**：
  - 默认状态：正常显示
  - 悬停状态：高亮边框，标题显示 ✏️ 图标
  - 选中状态：边框加粗，右侧面板展开
  - 编辑中：卡片显示"编辑中"图标（🖊️）

#### 实时同步
- **自动保存**：右侧面板编辑后 1 秒自动保存到 Markdown 文件
- **双向同步**：可视化视图 ↔ Markdown 文件（对用户透明）
- **冲突处理**：检测到外部修改时提示用户选择（保留本地/加载外部）

### 4. AI 集成感知
- **AI 生成内容可视化**：实时显示 AI 正在生成哪个章节/段落
- **结构化校验**：AI 校验结果映射到具体节点（如"用户故事 3 缺少验收标准"）
- **内容建议**：AI 分析后在节点上显示优化建议

### 5. 用户友好性
- **无需 Markdown 知识**：富文本编辑器，工具栏按钮操作（加粗、斜体、列表等）
- **面向非技术人员**：PM、设计师、业务人员也能轻松使用
- **快捷键支持**：快速在节点间导航、编辑、折叠
- **性能优先**：支持大型文档（1000+ 行）不卡顿

## 技术约束

### 核心技术栈

#### 基础项目（改造基础）⭐
- **flowgram.ai demo-free-layout**: https://github.com/bytedance/flowgram.ai/tree/main/apps/demo-free-layout
  - ✅ **直接使用**其卡片节点渲染逻辑
  - ✅ **直接使用**其配置面板组件和保存逻辑
  - ✅ **直接使用**其拖拽、布局、交互系统
  - ✅ **尊崇**其架构规范和设计模式
  - ⚠️ **禁止**重新实现已有功能，必须复用
  
#### 扩展技术栈（在 flowgram.ai 基础上新增）
- **Markdown 解析**: unified ecosystem (remark/rehype)
  - `remark-parse`: 解析 Markdown AST
  - `mdast-util-*`: 遍历和操作抽象语法树
  - 用于：Markdown 文件 → flowgram.ai 节点数据
  
- **富文本编辑器**: TipTap + tiptap-markdown
  - 所见即所得（WYSIWYG）编辑体验
  - Markdown ↔ 富文本双向转换
  - 集成到 flowgram.ai 的配置面板中
  
- **桌面框架**: Tauri 1.5+（轻量、安全、跨平台）
  - 文件系统访问
  - 文件监听（Rust notify crate）

### 架构原则

#### 改造策略（基于 flowgram.ai）
- **复用 flowgram.ai 核心**:
  - 节点渲染引擎（卡片组件）
  - 配置面板系统（PropertiesPanel）
  - 拖拽和布局算法
  - 数据保存和加载逻辑
  
- **扩展层**（在 flowgram.ai 之上）:
  1. **Markdown 适配层**：Markdown 文件 ↔ flowgram.ai 节点数据格式
  2. **spec-kit 识别层**：识别用户故事、优先级、验收场景
  3. **富文本编辑层**：TipTap 集成到配置面板

- **三层架构**:
  ```
  ┌────────────────────────────────────────┐
  │  flowgram.ai 核心（复用）              │
  │  - 节点渲染                            │
  │  - 配置面板                            │
  │  - 拖拽交互                            │
  │  - 布局引擎                            │
  └──────────────┬─────────────────────────┘
                 │
  ┌──────────────────────────────────────┐
  │  扩展层（新增）                       │
  │  - Markdown 适配器                    │
  │  - spec-kit 识别器                    │
  │  - TipTap 富文本编辑器                │
  └──────────────┬───────────────────────┘
                 │
  ┌──────────────────────────────────────┐
  │  Markdown AST 层                      │
  │  - remark-parse (Markdown → AST)     │
  │  - remark-stringify (AST → Markdown) │
  └──────────────────────────────────────┘
  ```

- **数据流**:
  ```
  Markdown 文件 
       ↓ (remark-parse)
  Markdown AST 
       ↓ (Markdown 适配器)
  flowgram.ai 节点数据格式
       ↓ (flowgram.ai 核心)
  UI 渲染（卡片节点）
       ↓ (用户编辑)
  配置面板（flowgram.ai + TipTap）
       ↓ (保存逻辑)
  flowgram.ai 节点数据
       ↓ (Markdown 适配器)
  Markdown AST
       ↓ (remark-stringify)
  Markdown 文件
  ```

### 性能要求
- **解析性能**: 1000 行 Markdown 文件解析 < 100ms
- **渲染性能**: 100+ 节点流程图初始渲染 < 2s
- **交互性能**: 拖拽、缩放帧率 60fps
- **同步延迟**: 文件变化到节点更新 < 500ms

## 项目边界

### 范围内（v1）

#### 核心功能
- **Markdown 结构解析**:
  - 标题层级（# → ## → ### → ####）转换为节点层级
  - 列表项（- [ ] 任务）作为子节点
  - 代码块、引用块作为特殊节点类型
  
- **可视化展示**:
  - 思维导图式布局（从左到右）
  - 节点折叠/展开
  - 自由拖拽调整位置
  - 缩放和平移

- **内容编辑**:
  - 点击节点编辑文本（所见即所得）
  - 节点操作（新增、删除、移动）同步到 Markdown
  - 支持 Markdown 语法（加粗、斜体、链接等）

- **spec-kit 特化**:
  - 识别用户故事结构（标题 + 验收场景）
  - 识别优先级标记（P1、P2、P3）
  - 识别功能性需求（FR-001、FR-002）

- **AI 状态同步**:
  - 检测 AI 正在写入的章节
  - 显示 AI 生成进度（如"生成用户故事 2..."）
  - 校验结果映射到节点

#### 支持的文档类型
- constitution.md（宪章）
- spec.md（规范）
- plan.md（计划）
- tasks.md（任务）
- 任意符合 spec-kit 格式的 Markdown 文件

### 范围外（v1）

- **高级 Markdown 特性**:
  - 不解析复杂表格内部结构（表格作为一个整体节点）
  - 不支持 Mermaid/PlantUML 图表内嵌渲染
  - 不支持数学公式（LaTeX）的可视化编辑

- **协作功能**:
  - 不支持多用户实时协作编辑
  - 不支持评论和批注系统
  - 不支持版本对比和合并

- **其他**:
  - Git 集成（未来版本）
  - 云存储/同步（仅本地文件系统）
  - 移动端支持
  - 导出为图片/PDF（未来版本）

## Markdown 解析策略

### 节点类型映射（卡片展示）

| Markdown 元素 | 节点卡片类型 | 层级 | 卡片展示内容 | 编辑方式 |
|--------------|-------------|------|-------------|---------|
| `# 标题` | **根节点卡片** | L1 | 📄 图标 + 标题 + 文档类型标签 | 双击卡片标题编辑 |
| `## 章节` | **主节点卡片** | L2 | 📑 图标 + 章节标题 + 子节点数量 | 双击编辑；⚙️ 打开配置 |
| `### 子章节` | **子节点卡片** | L3 | 📝 图标 + 标题 + 优先级标记（P1/P2/P3） | 双击编辑；⚙️ 打开配置 |
| `#### 四级标题` | **叶节点卡片** | L4 | 📋 图标 + 标题 + 内容摘要（前2行） | 双击编辑；⚙️ 打开配置 |
| `- [ ] 任务` | **任务卡片** | L+1 | ✅ 复选框 + 任务文本 + 状态图标 | 点击复选框切换状态 |
| `**加粗段落**` | **强调卡片** | L+1 | ⚡ 图标 + 加粗文本 | 双击编辑 |
| ` ```代码块``` ` | **代码卡片** | L+1 | 💻 图标 + 语言标签 + 折叠预览 | ⚙️ 打开代码编辑器 |
| `> 引用` | **引用卡片** | L+1 | 💬 图标 + 引用内容 + 引用线 | 双击编辑 |

**卡片尺寸**：
- 标准卡片：200px × 80px（自适应内容高度）
- 展开卡片：200px × 自动高度（显示完整摘要）
- 最大卡片：400px × 600px（配置面板打开时）

### spec-kit 特定识别（卡片展示）

```markdown
### 用户故事 1 - 自由布局可视化文档结构（优先级：P1）
     ↓ 解析为
节点卡片 {
  type: 'user-story',
  title: '自由布局可视化文档结构',
  priority: 'P1',
  
  // 卡片展示
  card: {
    icon: '📖',
    badge: 'P1' (红色高亮),
    preview: '作为 spec-kit 用户，我希望...',  // 前 50 字
    metadata: {
      storyNumber: 1,
      status: 'draft',
      wordCount: 230
    }
  },
  
  // 编辑能力
  editing: {
    quickEdit: true,      // 双击卡片标题可直接编辑
    configPanel: true,    // 点击 ⚙️ 打开右侧配置面板
    richTextEditor: true  // 配置面板使用 TipTap 富文本编辑器
  },
  
  children: [
    { type: 'section', title: '为何该优先级', ... },
    { type: 'section', title: '独立测试', ... },
    { type: 'section', title: '验收场景', ... }
  ]
}
```

**卡片 UI 示例**：
```
┌──────────────────────────────────┐
│ 📖 用户故事 1                [P1]│ ← 标题栏：图标 + 标题 + 优先级徽章
├──────────────────────────────────┤
│ 自由布局可视化文档结构            │ ← 主标题（可双击编辑）
│                                  │
│ 作为 spec-kit 用户，我希望在...  │ ← 内容预览（前 2 行）
│                                  │
├──────────────────────────────────┤
│ 📊 草稿 | 230 字 | 10分钟前   [⚙️]│ ← 底栏：元数据 + 配置按钮
└──────────────────────────────────┘
   ↓ (双击主标题)
编辑状态：[自由布局可视化文档结构▊]
   ↓ (点击 ⚙️)
右侧弹窗：富文本编辑器（TipTap）+ 完整内容
```

### 布局算法

**思维导图布局**（从左到右）：

```
[Root]──────────────┬─────[L2 节点 1]─────┬─────[L3 节点 1.1]
                    │                      ├─────[L3 节点 1.2]
                    │                      └─────[L3 节点 1.3]
                    │
                    ├─────[L2 节点 2]─────┬─────[L3 节点 2.1]
                    │                      └─────[L3 节点 2.2]
                    │
                    └─────[L2 节点 3]
```

**自动布局规则**：
- X 轴：每层级间隔 300px
- Y 轴：同级节点垂直间隔 80px，避免重叠
- 用户拖拽后保存相对偏移量（不完全覆盖自动布局）

## 质量标准

### 代码质量
- TypeScript 严格模式，类型覆盖率 100%
- Markdown 解析逻辑单元测试覆盖率 90%+
- 节点渲染和交互测试覆盖率 80%+
- ESLint + Prettier 强制执行

### 文档
- Markdown AST 映射逻辑文档化
- 布局算法说明文档
- spec-kit 特定识别规则文档
- 用户快速入门指南

### 用户体验
- 键盘导航：Tab/方向键在节点间移动，Enter 编辑
- 快捷键：
  - `Ctrl+E`: 展开/折叠所有节点
  - `Ctrl+F`: 搜索节点内容
  - `/`: 聚焦到根节点
- 可访问性：WCAG 2.1 AA（屏幕阅读器支持）

## 决策制定

### 何时添加功能
1. 是否增强了 Markdown 内容的可视化理解？
2. 是否符合思维导图的交互习惯？
3. 是否与 spec-kit 方法论契合？
4. 能否在不破坏现有解析逻辑的情况下实现？

如果以上问题全部为是，则执行 spec → plan → tasks → implement 循环。

### 解析逻辑何时重构
- 当新的 Markdown 元素需要支持时（如表格内部解析）
- 当 spec-kit 引入新的文档结构约定时
- 当性能无法满足大型文档（5000+ 行）需求时

## 成功指标

### MVP（最小可行产品）
- [ ] 正确解析并可视化 spec.md 的所有层级（# → ## → ### → ####）
- [ ] 用户故事、验收场景自动识别并特殊展示（带优先级标记）
- [ ] 点击节点可编辑内容，保存后同步到 Markdown 文件
- [ ] 支持节点折叠/展开和自由拖拽
- [ ] 思维导图布局（从左到右）自动生成
- [ ] 性能：解析 1000 行 spec.md < 200ms，渲染 < 2s

### V1.0
- [ ] 支持所有 spec-kit 文档类型（constitution、spec、plan、tasks）
- [ ] AI 生成内容实时可视化（显示正在生成的节点）
- [ ] AI 校验结果映射到节点（显示问题图标和详情）
- [ ] 节点搜索和过滤（按类型、优先级、关键词）
- [ ] 导出为纯文本大纲视图
- [ ] 多文档同时打开（标签页切换）

## 不可协商项

### 技术要求
1. **必须**基于 flowgram.ai demo-free-layout 改造（不从零实现）⭐
   - 复用其节点渲染、配置面板、拖拽、布局等核心功能
   - 尊崇其架构规范和设计模式
   - 不要重新实现已有功能
2. **必须**保持 Markdown 文件格式完全兼容（任何文本编辑器都能正常编辑）
3. **必须**双向同步（可视化编辑 = 文件编辑，文件编辑 = 可视化更新）
4. **必须**离线工作（不依赖云服务）
5. **必须**开源（MIT 许可证）
6. **必须**支持英文和中文文档

### 开发流程要求（SDD 严格流程）⚠️

**所有功能开发必须严格遵循以下步骤，不得跳过或提前：**

1. **STEP 1: 编写 Specification (spec.md)**
   - 定义用户故事、验收标准、功能需求
   - 明确成功标准和范围边界
   
2. **STEP 2: 用户确认 Specification** ✅
   - **等待用户明确确认** spec.md 内容无误
   - 确认核心定位、技术选型方向
   - **未确认前，禁止进入下一步**

3. **STEP 3: 编写 Implementation Plan (plan.md)**
   - 基于**已确认的** spec 制定技术方案
   - 定义架构、组件、阶段划分
   
4. **STEP 4: 用户确认 Plan** ✅
   - **等待用户明确确认** plan.md 的技术方案
   - 确认架构设计、技术选型、时间估算
   - **未确认前，禁止进入下一步**

5. **STEP 5: 编写 Task Breakdown (tasks.md)**
   - 基于**已确认的** plan 分解具体任务
   - 每个任务包含验收标准
   
6. **STEP 6: 用户确认 Tasks** ✅
   - **等待用户明确确认** tasks.md 的任务分解
   - 确认实施顺序、任务粒度
   - **未确认前，禁止开始实施**

7. **STEP 7: 实施 (Implementation)**
   - 仅在所有文档确认后开始编码
   - 按照 tasks.md 逐步实施

**违规后果**：
- ❌ 在 spec 未确认前生成 plan/tasks → 删除所有提前生成的文档，重新开始
- ❌ 跳过确认步骤 → 后续工作全部作废，从未确认的步骤重新开始
- ❌ 一次性生成所有文档 → 视为严重违规，清空后重新逐步进行

**为什么必须严格执行**：
- 避免基于未确认的假设进行大量工作
- 用户可能对 spec 有重大调整（如本次的"内容结构可视化"定位变更）
- 逐步确认可以及时发现问题，避免返工

---

## 技术研究要点

### 必须深入研究的技术

#### 1. flowgram.ai 项目结构分析（改造基础）⭐
**必须完整理解以下模块**：
- **节点数据格式**: flowgram.ai 的节点定义（Node interface）
- **配置面板系统**: PropertiesPanel 组件及其扩展机制
- **保存和加载**: 数据序列化/反序列化逻辑
- **布局引擎**: 自动布局算法和手动调整
- **拖拽系统**: 节点拖拽、画布平移、缩放实现
- **状态管理**: flowgram.ai 使用的状态管理方案

**关键原则**：
- ✅ **复用代码**：能用 flowgram.ai 的就不要重写
- ✅ **尊崇规范**：遵循其组件结构和命名约定
- ✅ **最小改动**：仅在必要时扩展，不破坏原有架构

#### 2. Markdown AST 操作（扩展层）
- `unified` 生态系统（remark、rehype）
- AST 节点类型定义（mdast）
- 双向转换：AST ↔ Markdown text
- **核心任务**：编写适配器，将 Markdown AST 转换为 flowgram.ai 节点格式

#### 3. TipTap 集成（扩展层）
- 集成到 flowgram.ai 的配置面板中
- Markdown ↔ 富文本双向转换
- 自定义工具栏和扩展

---

**宪章版本**: v2.0  
**最后更新**: 2025-10-31  
**状态**: ✅ 已根据内容结构可视化定位更新

